<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Tableau de bord RH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-50 text-gray-800">
    <!-- Barre sup√©rieure -->
    <header class="flex justify-between items-center px-6 py-4 bg-white shadow">
      <h1 class="text-xl font-bold text-green-700">
        ESPACE D‚ÄôAPPEL √Ä CANDIDATURE
      </h1>
      <form method="POST" action="{{ url_for('auth.logout') }}">
        <button
          type="submit"
          class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
        >
          Se d√©connecter
        </button>
      </form>
    </header>

    <main class="p-6">
      <h2 class="text-lg mb-4">
        Bienvenue, {{ current_user.nom }} {{ current_user.prenom }}
      </h2>

      <div class="mb-6">
        <a
          href="{{ url_for('appel.creer_appel') }}"
          class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
        >
          + Cr√©er un nouvel appel
        </a>
      </div>

      <!-- Filtres -->
      <div class="space-y-4 mb-6">
        <h3 class="text-md font-semibold">Rechercher</h3>
        <form id="filtre-form" class="flex flex-wrap gap-4">
          <input
            type="text"
            id="filtre-titre"
            placeholder="üîç Nom appel"
            class="border px-3 py-2 rounded w-48"
          />
          <input
            type="date"
            id="filtre-date"
            class="border px-3 py-2 rounded w-48"
          />
          <input
            type="text"
            id="filtre-critere"
            placeholder="üìå Crit√®re"
            class="border px-3 py-2 rounded w-48"
          />
          <button
            type="submit"
            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
          >
            Rechercher
          </button>
        </form>

        <div class="flex gap-4">
          <button
            onclick="filtrerParStatut('tous')"
            class="bg-green-600 text-white px-4 py-1 rounded"
          >
            Tous
          </button>
          <button
            onclick="filtrerParStatut('encours')"
            class="bg-orange-500 text-white px-4 py-1 rounded"
          >
            En cours
          </button>
          <button
            onclick="filtrerParStatut('termines')"
            class="bg-gray-500 text-white px-4 py-1 rounded"
          >
            Termin√©s
          </button>
        </div>
      </div>

      <!-- Tableau -->
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white shadow rounded">
          <thead class="bg-green-100 text-green-800 font-semibold">
            <tr>
              <th class="px-4 py-2">Nom Appel</th>
              <th class="px-4 py-2">Date D√©but</th>
              <th class="px-4 py-2">Date Fin</th>
              <th class="px-4 py-2">Description</th>
              <th class="px-4 py-2">Crit√®res</th>
              <th class="px-4 py-2">Lien</th>
              <th class="px-4 py-2">Actions</th>
            </tr>
          </thead>
          <tbody class="text-center">
            {% for appel in appels %}
            <tr class="border-b hover:bg-gray-50">
              <td class="px-4 py-2">{{ appel.titre }}</td>
              <td class="px-4 py-2">
                {{ appel.date_debut.strftime('%d/%m/%Y') }}
              </td>
              <td class="px-4 py-2">
                {{ appel.date_fin.strftime('%d/%m/%Y') }}
              </td>
              <td class="px-4 py-2">{{ appel.description[:100]|safe }}...</td>
              <td class="px-4 py-2">
                <ul class="text-left">
                  {% for critere in appel.criteres %}
                  <li>‚Ä¢ {{ critere.intitule }}</li>
                  {% endfor %}
                </ul>
              </td>
              <td class="px-4 py-2">
                <a
                  href="{{ appel.lien_formulaire }}"
                  class="text-green-600 underline"
                  target="_blank"
                  >Voir formulaire</a
                >
              </td>
              <td class="px-4 py-2 flex items-center justify-center space-x-3">
                <a
                  href="{{ url_for('candidat.list_candidatures', appel_id=appel.id) }}"
                  title="Voir"
                >
                  <i class="fas fa-eye text-green-500 hover:scale-110"></i>
                </a>
                <a
                  href="{{ url_for('appel.edit_appel', appel_id=appel.id) }}"
                  title="Modifier"
                >
                  <i class="fas fa-edit text-yellow-500 hover:scale-110"></i>
                </a>
                <a
                  href="#"
                  onclick="confirmerSuppression({{ appel.id }})"
                  title="Supprimer"
                >
                  <i class="fas fa-trash text-red-600 hover:scale-110"></i>
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </main>

    <!-- Modal suppression -->
    <div
      id="confirmationModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
    >
      <div class="bg-white p-6 rounded shadow-lg text-center">
        <p class="mb-4 text-lg">
          ‚ùó √ätes-vous s√ªr de vouloir supprimer cet appel ?
        </p>
        <form id="deleteForm" method="POST">
          <button
            type="submit"
            class="bg-red-600 text-white px-4 py-2 rounded mr-2"
          >
            Oui, Supprimer
          </button>
          <button
            type="button"
            onclick="fermerModal()"
            class="bg-gray-300 px-4 py-2 rounded"
          >
            Annuler
          </button>
        </form>
      </div>
    </div>

    <script>
      function filtrerTableau() {
        const titre = document
          .getElementById("filtre-titre")
          .value.toLowerCase();
        const date = document.getElementById("filtre-date").value;
        const critere = document
          .getElementById("filtre-critere")
          .value.toLowerCase();

        const rows = document.querySelectorAll("tbody tr");

        rows.forEach((row) => {
          const colTitre = row
            .querySelector("td:nth-child(1)")
            .textContent.toLowerCase();
          const colDate = row.querySelector("td:nth-child(2)").textContent;
          const colCrit = row
            .querySelector("td:nth-child(5)")
            .textContent.toLowerCase();

          const matchTitre = colTitre.includes(titre);
          const matchDate = !date || colDate === formatDate(date);
          const matchCrit = colCrit.includes(critere);

          row.style.display =
            matchTitre && matchDate && matchCrit ? "" : "none";
        });
      }

      function formatDate(inputDate) {
        const date = new Date(inputDate);
        return date.toLocaleDateString("fr-FR");
      }

      document
        .getElementById("filtre-titre")
        .addEventListener("input", filtrerTableau);
      document
        .getElementById("filtre-date")
        .addEventListener("input", filtrerTableau);
      document
        .getElementById("filtre-critere")
        .addEventListener("input", filtrerTableau);
    </script>
    <script>
      function confirmerSuppression(appelId) {
        const modal = document.getElementById("confirmationModal");
        const form = document.getElementById("deleteForm");

        // Assure que la route POST pour la suppression est bien d√©finie
        form.action = `/appel/${appelId}/delete`;

        // Affiche le modal
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }

      function fermerModal() {
        const modal = document.getElementById("confirmationModal");
        modal.classList.remove("flex");
        modal.classList.add("hidden");
      }

      // Fermer le modal si clic √† l'ext√©rieur
      window.onclick = function (event) {
        const modal = document.getElementById("confirmationModal");
        if (event.target === modal) {
          fermerModal();
        }
      };
    </script>
    <script>
      function filtrerParStatut(statut) {
        const rows = document.querySelectorAll("tbody tr");
        const aujourdHui = new Date();

        rows.forEach((row) => {
          const dateFinTexte = row
            .querySelector("td:nth-child(3)")
            .textContent.trim();
          const [jour, mois, annee] = dateFinTexte.split("/").map(Number);
          const dateFin = new Date(annee, mois - 1, jour);

          let afficher = true;

          if (statut === "encours") {
            afficher = dateFin >= aujourdHui;
          } else if (statut === "termines") {
            afficher = dateFin < aujourdHui;
          }

          row.style.display = statut === "tous" || afficher ? "" : "none";
        });
      }
    </script>
  </body>
</html>
